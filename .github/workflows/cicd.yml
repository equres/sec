name: CI/CD

on:
  push:
    branches:
      - '*'
jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          stable: 'false'
          go-version: '1.16'
        
      - name: Clean Up Code
        run: make clean
  golangci:
    needs: format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2
        with:
          version: 'latest'
  build:
    needs: golangci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          stable: 'false'
          go-version: '1.16'
        
      - name: Delete Old Apps
        run: rm ./sec
        
      - name: Build App
        run: make build

      - name: Generate MD5 Checksum
        run: openssl md5 sec

      - name: View Dirs/Files
        run: ls -la
      
      - uses: actions/cache@v2
        with:
          path: ./sec
          key: ${{ runner.os }}-${{ hashFiles('sec') }}-sec-binary
  functional-tests:
    needs: build
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_USER: test_postgres
          POSTGRES_PASSWORD: test_postgres
          POSTGRES_DB: sec_project
          POSTGRES_PORT: 5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          stable: 'false'
          go-version: '1.16'
      
      - name: Changing Permissions For SEC Binary
        run: chmod 755 ./sec

      - name: Copy Config File
        run: |
          sudo mkdir ~/.config/sec/
          sudo cp ./ci/config.yaml ~/.config/sec/config.yaml

      - name: Run Migration
        run: make migrateup

      - name: Install PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install --yes postgresql-client

      - name: Testing Database
        run: | 
          ./sec de 2021/06
          ./sec dlist
      
      - name: View Dirs/Files Again
        run: ls -la
  deploy: 
    needs: functional-tests
    # if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          stable: 'false'
          go-version: '1.16'
      
      - name: Changing Permissions For SEC Binary
        run: chmod 755 ./sec

      - name: Copy App to Production Server
        run: |
          set -x
          set -e
          uname -a
          pwd
          ls -la
          whoami
          mkdir -p ~/.ssh
          echo "${{ secrets.SECPROD_PRIV_KEY }}" > ~/.ssh/id_rsa
          chmod 700 ~/.ssh/id_rsa
          eval `ssh-agent -s`
          ssh-keyscan -H equres.com >> ~/.ssh/known_hosts
          ssh-add

          echo "New program MD5"
          openssl md5 sec
          echo "Old program MD5"
          ssh sec@equres.com 'openssl md5 sec'

          echo "Moving things"
          ssh sec@equres.com mv sec sec.old

          echo "Uploading the new binary"
          scp ./sec sec@equres.com:/home/sec/sec.new
